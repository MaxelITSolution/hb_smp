/*!
 * Lionade JavaScript Library v1.0
 * http://lionadejs.com/
 *
 * Copyright 2015, Muhammad Rizki Akbar
 * Dual licensed under the MIT or GPL Version 2 licenses.
 * http://lionadejs.com/license
 */

!function(e){e.fn.datagrid=function(t){function i(){var t="<thead></thead><tbody></tbody>";e(P).append(t)}function r(){var t="<tr id='thead-merge-cells'></tr>";if(e(P).find("thead").append(t),1==E.rowNumber){var i="<th sortable='false' style='text-align: center; width: 20px;' rowspan='2'>No</th>";e(P).find("#thead-merge-cells").append(i)}if(1==E.rowCheck){var r="<th sortable='false' style='text-align: center; width: 20px;' rowspan='2'><input type='checkbox'></th>";e(P).find("#thead-merge-cells").append(r),u()}if(!e.isEmptyObject(E.rowDetail)){var a="<th sortable='false' style='text-align: center; width: 20px;' rowspan='2'></th>";e(P).find("#thead-merge-cells").append(a)}E.columns.forEach(function(t,i){var r=!1,a="",n="",o="";E.mergeCells.forEach(function(e){i==e.index&&(r=!0,a=e.align,n=e.colspan,o=e.title)}),r||E.mergeCells.forEach(function(e){i>e.index&&i<e.index+e.colspan&&(r=null)});var l="";r?l="<th sortable='false' style='text-align: "+a+";' colspan='"+n+"'>"+o+"</th>":0==r&&(l="<th title='"+t.field+"' sortable='"+t.sortable+"' style='text-align: "+t.align+"; width: "+t.width+"px;' rowspan='2'>"+t.title+"</th>"),e(P).find("#thead-merge-cells").append(l)})}function a(){var t="<tr id='thead-title'></tr>";if(e(P).find("thead").append(t),1==E.rowNumber&&0==E.mergeCells.length){var i="<th sortable='false' style='text-align: center; width: 20px;'>No</th>";e(P).find("#thead-title").append(i)}if(1==E.rowCheck&&0==E.mergeCells.length){var r="<th sortable='false' style='text-align: center; width: 20px;'><input type='checkbox'></th>";e(P).find("#thead-title").append(r),u()}if(!e.isEmptyObject(E.rowDetail)&&0==E.mergeCells.length){var a="<th sortable='false' style='text-align: center; width: 20px;'></th>";e(P).find("#thead-title").append(a)}E.columns.forEach(function(t,i){var r=!1;E.mergeCells.length>0?E.mergeCells.forEach(function(e){i>=e.index&&i<e.index+e.colspan&&(r=!0)}):r=!0;var a;r&&(a="<th title='"+t.field+"' sortable='"+t.sortable+"' style='text-align: "+t.align+"; width: "+t.width+"px;'>"+t.title+"</th>"),e(P).find("#thead-title").append(a)})}function n(t,i,r){var a,n=e.extend({limit:parseInt(t)*i-i,offset:i,sort:E.sortBy,order:E.orderBy,dataSearch:r},E.queryParams);return e.ajax({url:E.url,async:!1,type:"post",dataType:"json",data:n,success:function(e){a=e}}),a}function o(t){var i=E.columns.length+(c()+1),r="<tr><td colspan='"+i+"' style='text-align: center;'>"+t+"</td></tr>";e(P).find("tbody").html(r)}function l(t,i,r){o("Loading data..."),C=n(t,i,r);var a=parseInt(t)*i-i+1,l="",d="",c="";if(C.total>=1){for(var p=0;p<C.rows.length;p++)l+="<tr class='main-row'>",E.rowNumber&&(l+="<td style='text-align: center;'>"+a+"</td>"),E.rowCheck&&(l+="<td class='checkbox-column' style='text-align: center;'><input value='"+C.rows[p][E.primaryField]+"' type='checkbox'></td>"),e.isEmptyObject(E.rowDetail)||(l+="<td style='text-align: center;'><div class='detail-link' data-id='"+p+"' data-expand='false' style='width: 10px; height: 4px; margin-left: auto; margin-right: auto; cursor: pointer; margin-top: 8px; background-color: #595959; border: 1px solid #595959; -border-radius: 0.1em; -moz-border-radius: 0.1em; -webkit-border-radius: 0.1em;'><div style='width: 4px; height: 10px; cursor: pointer; margin-top: -4px; margin-left: 2px; background-color: #595959; border: 1px solid #595959; -border-radius: 0.1em; -moz-border-radius: 0.1em; -webkit-border-radius: 0.1em;'></div></div></td>"),E.columns.forEach(function(e){void 0!=C.rows[p][e.field]?l+="<td style='text-align: "+e.align+"; width: "+e.width+"px;'>"+C.rows[p][e.field]+"</td>":(d=C.rows[p],c=p,l+="<td style='text-align: "+e.align+"; width: "+e.width+"px;'>"+e.rowStyler(C.rows[p],p)+"</td>")}),l+="</tr>",a++;e(P).find("tbody").html(l)}else o("No records found...");s(t,i),h(),v(t,i),w()}function s(t,i){var r="";r+='<li title="first"><a href="javascript:void(0);">First</a></li>',r+='<li title="prev"><a href="javascript:void(0);">Prev</a></li>',t==Math.ceil(C.total/i)&&t-2>=1&&(r+='<li title="'+(t-2)+'"><a href="javascript:void(0);">'+(t-2)+"</a></li>"),t-1>=1&&(r+='<li title="'+(t-1)+'"><a href="javascript:void(0);">'+(t-1)+"</a></li>"),r+='<li class="active" title="'+t+'"><a href="javascript:void(0);">'+t+"</a></li>",t+1<=Math.ceil(C.total/i)&&(r+='<li title="'+(t+1)+'"><a href="javascript:void(0);">'+(t+1)+"</a></li>"),1==t&&Math.ceil(C.total/i)>2&&(r+='<li title="'+(t+2)+'"><a href="javascript:void(0);">'+(t+2)+"</a></li>"),r+='<li title="next"><a href="javascript:void(0);">Next</a></li>',r+='<li title="last"><a href="javascript:void(0);">Last</a></li>',e(E.pagingElement).html(r),e(E.pagingElement).children("li").each(Math.ceil(C.total/i)>1?function(){e(this).on("click",function(){"prev"==this.title&&t-1>=1?(l(t-1,i,g()),E.activePageNumber--):"next"==this.title&&t+1<=Math.ceil(C.total/i)?(l(t+1,i,g()),E.activePageNumber++):"first"==this.title?(l(1,i,g()),E.activePageNumber=1):"last"==this.title?(l(Math.ceil(C.total/i),i,g()),E.activePageNumber=Math.ceil(C.total/i)):(parseInt(this.title)<=t+2||parseInt(this.title)>=t-2)&&(l(parseInt(this.title),i,g()),E.activePageNumber=this.title)})}:function(){e(this).off()})}function d(){for(var t="",i=0;i<E.itemsPerPageOption.length;i++)t+="<option value='"+E.itemsPerPageOption[i]+"'>"+E.itemsPerPageOption[i]+"</option>";e(E.optionPagingElement).html(t),e(E.optionPagingElement).val(E.itemsPerPage),e(E.optionPagingElement).on("change",function(){E.itemsPerPage=e(E.optionPagingElement).children("option:selected").val(),l(1,E.itemsPerPage,g())})}function c(){var t=-1;return 1==E.rowNumber?t+=1:"",1==E.rowCheck?t+=1:"",e.isEmptyObject(E.rowDetail)?"":t+=1,t}function h(){e(P).find(".checkbox-column").each(function(){e(this).children().each(function(){for(var t=0;t<E.rowChecked.length;t++)E.rowChecked[t]==e(this).attr("value")&&e(this).prop("checked",!0);e(this).on("click",function(){for(var e,t=!1,i=0;i<E.rowChecked.length;i++)E.rowChecked[i]==this.value&&(t=!0,e=i);t?E.rowChecked.splice(e,1):E.rowChecked[E.rowChecked.length]=parseInt(this.value),p()})})}),p()}function p(){for(var t=e(P).children("thead").find('input[type="checkbox"]'),i=f(),r=!0,a=0;a<i.length;a++)e(i[a]).prop("checked")||(r=!1);r?t.prop("checked",!0):t.prop("checked",!1)}function f(){var t=[];return e(P).find(".checkbox-column").each(function(){e(this).children().each(function(){t[t.length]=e(this)})}),t}function u(){var t=e(P).children("thead").find('input[type="checkbox"]');e(t).on("click",function(){var t=f();if(e(this).prop("checked"))for(var i=0;i<t.length;i++){e(t[i]).prop("checked",!0);for(var r,a=!1,n=0;n<E.rowChecked.length;n++)E.rowChecked[n]==e(t[i]).attr("value")&&(a=!0,r=n);a||(E.rowChecked[E.rowChecked.length]=parseInt(e(t[i]).attr("value")))}else for(var i=0;i<t.length;i++){e(t[i]).prop("checked",!1);for(var r,a=!1,n=0;n<E.rowChecked.length;n++)E.rowChecked[n]==e(t[i]).attr("value")&&(a=!0,r=n);a&&E.rowChecked.splice(r,1)}})}function m(){E.columns.forEach(function(t){t.search&&e(E.searchFieldElement).append('<option value="'+t.field+'">'+t.title+"</option>")}),e(E.searchInputElement).on("keyup",function(){l(1,E.itemsPerPage,g())}),e(E.searchFieldElement).on("change",function(){l(1,E.itemsPerPage,g())})}function g(){var t=e(E.searchFieldElement).val(),i=e(E.searchInputElement).val(),r={field:t,value:i};return void 0==t||void 0==i?"":r}function v(t,i){if(C.total>=1){var r,a;r=t*i-i+1,a=t==Math.ceil(C.total/i)?t*i-(t*i-C.total):t*i,e(E.pageInfoElement).html("Showing "+r+" - "+a+" of "+C.total+" entries")}else e(E.pageInfoElement).html("Showing 0 - 0 of 0 entries")}function x(){e(P).children("thead").children().children().each(function(t,i){if("false"!=e(i).attr("sortable")){var r=e("<span></span>");e(r).css({width:"0px",height:"0px",border:"4px solid transparent","border-bottom":"5px solid #ccc",position:"absolute","margin-left":"5px","margin-top":"0px"}),e(this).append(r);var a=e("<span></span>");e(a).css({width:"0px",height:"0px",border:"4px solid transparent","border-top":"5px solid #ccc",position:"absolute","margin-left":"5px","margin-top":"11px"}),e(this).append(a)}})}function b(){E.sortBy=E.primaryField,x(),e(P).children("thead").children().children().each(function(t,i){"false"!=e(i).attr("sortable")&&(e(this).css("cursor","pointer"),e(this).on("click",function(){e(P).children("thead").children().children().each(function(){e(this).children("span").remove()}),x();var t=e("<span></span>");e(this).append(t),null==e(this).attr("data-sortby")||"DESC"==e(this).attr("data-sortby")?(e(this).attr("data-sortby","ASC"),e(this).children("span").css({width:"0px",height:"0px",border:"4px solid transparent","border-bottom":"5px solid #333",position:"absolute","margin-left":"5px","margin-top":"3px"})):(e(this).attr("data-sortby","DESC"),e(this).children("span").css({width:"0px",height:"0px",border:"4px solid transparent","border-top":"5px solid #333",position:"absolute","margin-left":"5px","margin-top":"7px"})),E.sortBy=this.title,E.orderBy=e(this).attr("data-sortby"),l(E.activePageNumber,E.itemsPerPage,g())}))})}function w(){e(P).find(".detail-link").each(function(){e(this).off(),e(this).on("click",function(){var t=e(this).attr("data-id");if("false"==e(this).attr("data-expand")){var i="<tr id='detail-row-"+t+"' style='display: none;'><td colspan='3'></td><td colspan='9' class='detail-content'>"+E.rowDetail.formatter(C.rows[t],t);e(i).insertAfter(e(this).closest("tr")).fadeIn(),E.rowDetail.onExpandRow(C.rows[t],t);var r="<div class='detail-link' data-id='"+t+"' data-expand='true' style='width: 10px; height: 4px; margin-left: auto; margin-right: auto; cursor: pointer; margin-top: 8px; background-color: #595959; border: 1px solid #595959; -border-radius: 0.1em; -moz-border-radius: 0.1em; -webkit-border-radius: 0.1em;'></div>";e(this).closest("td").html(r)}else{e(this).closest("tr").next().fadeOut(function(){e(this).remove()});var r="<div class='detail-link' data-id='"+t+"' data-expand='false' style='width: 10px; height: 4px; margin-left: auto; margin-right: auto; cursor: pointer; margin-top: 8px; background-color: #595959; border: 1px solid #595959; -border-radius: 0.1em; -moz-border-radius: 0.1em; -webkit-border-radius: 0.1em;'><div style='width: 4px; height: 10px; cursor: pointer; margin-top: -4px; margin-left: 2px; background-color: #595959; border: 1px solid #595959; -border-radius: 0.1em; -moz-border-radius: 0.1em; -webkit-border-radius: 0.1em;'></div></div>";e(this).closest("td").html(r)}w()})})}function k(t,i,r,a,n,o){if(i>c()){var l,s;if(E.columns.forEach(function(e,t){t+c()+1==i&&(l=e.editable,s=e.field)}),l){var d,l=e(t).html(),h=a(s,l);if(E.columns.forEach(function(e,t){e.editable&&(d=t)}),"active"!=e(t).attr("inline-edit"))e(t).attr("inline-edit","active"),e(t).html("<form>"+h+"</form>"),d+c()+1==i&&n();else{e(t).attr("inline-edit","not-active");var p=e(t).children("form").serializeArray();e(t).html(p[0].value),C.rows[r][s]=p[0].value,d+c()+1==i&&o()}}}}function y(t,i,r,a,n,o){e(t).children().each(function(t){"all"==i?k(e(this),t,r,a,n,o):t==i+c()+1&&k(e(this),t,r,a,n,o)})}var P=e(this),C=[],E=e.extend({url:"",primaryField:"",sortBy:"",orderBy:"DESC",pagingElement:"",optionPagingElement:"",searchFieldElement:"",searchInputElement:"",pageInfoElement:"",rowNumber:!1,rowCheck:!1,columns:[],mergeCells:[],activePageNumber:1,itemsPerPage:5,itemsPerPageOption:[5,10,15,20],rowChecked:[],queryParams:{},rowDetail:{}},t);return this.reload=function(){l(E.activePageNumber,E.itemsPerPage,g())},this.getChecked=function(){return E.rowChecked},this.setChecked=function(e){for(var t=0;t<e.length;t++){for(var i=!1,r=0;r<E.rowChecked.length;r++)E.rowChecked[r]==e[t]&&(i=!0);i||(E.rowChecked[E.rowChecked.length]=e[t])}l(E.activePageNumber,E.itemsPerPage,g())},this.setUnchecked=function(e){for(var t=0;t<e.length;t++){for(var i,r=!1,a=0;a<E.rowChecked.length;a++)E.rowChecked[a]==e[t]&&(r=!0,i=a);r&&E.rowChecked.splice(i,1)}l(E.activePageNumber,E.itemsPerPage,g())},this.getRowData=function(e){return"all"==e?C.rows:C.rows[e]},this.editable=function(t){var i=e.extend({rowIndex:"all",columnIndex:"all",styler:function(e,t){return t},onEdit:function(){console.log("Edited")},onSave:function(){console.log("Saved")}},t);e(P).children("tbody").children(".main-row").each(function(t){"all"==i.rowIndex?y(e(this),i.columnIndex,t,i.styler,i.onEdit,i.onSave):t==i.rowIndex&&y(e(this),i.columnIndex,t,i.styler,i.onEdit,i.onSave)})},this.queryParams=function(t){E.queryParams=e.extend(E.queryParams,t)},this.run=function(){i(),E.mergeCells.length>0&&r(),a(),b(),l(E.activePageNumber,E.itemsPerPage,g()),d(),m()},this}}(jQuery);